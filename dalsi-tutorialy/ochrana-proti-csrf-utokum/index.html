<!doctype html><html lang="cs"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes,maximum-scale=2.2,minimum-scale=1"><link rel="icon" type="image/svg+xml" href="../../static/img/favicon.svg"><meta name="author" content="Jiří Satora"><meta name="description" content="Článek o ochraně proti CSRF útokům v servletech."><title>Ochrana proti CSRF útokům | Servlety a JSP - Návod</title><script src="../../static/js/highlight.min.js"></script><script>hljs.highlightAll()</script><script defer="defer" src="../../common.094d85ce485e92e2c2cb.js"></script><script defer="defer" src="../../618.274f04aa314232891610.js"></script><script defer="defer" src="../../tutorial.b2801240233e8db2580e.js"></script><link href="../../css/style.6e25b2d24c1ac501c94b.css" rel="stylesheet"></head><body><input type="hidden" id="PATH_TO_ROOT" value="../../"><header id="HeaderContainer" class="header"><div id="Header" class="header__container"><div class="header__content"><a href="../../" class="header__home-link">Servlety a JSP<span class="header__home-link-unimportant-part"> - Návod</span></a> <button id="NavigationToggleButton" class="menu-toggle-button">Otevřít/Zavřít menu<span class="menu-toggle-button__icon"></span></button><nav id="HeaderNavigation" class="header__navigation"><ul><li><a href="../../tutorial/priprava-pro-vyvoj/" class="header__navigation-link">Tutoriál</a></li><li><a href="../../obsah/" class="header__navigation-link">Obsah</a></li><li><a href="../../dalsi-tutorialy/k-cemu-tato-sekce-slouzi/" class="header__navigation-link header__navigation-link--active">Další tutoriály</a></li><li><a href="https://github.com/Jirkasa/servlety-a-jsp-navod" target="_blank" class="header__navigation-link">GitHub</a></li></ul></nav></div></div></header><div class="tutorial-page-layout"><div class="tutorial-page-layout__container"><nav id="TutorialNavigation" class="tutorial-page-layout__navigation-side"><ul class="navigation"><li><a href="../k-cemu-tato-sekce-slouzi/" class="navigation__link">K čemu tato sekce slouží</a></li><li><a href="../servlet-router/" class="navigation__link">Servlet Router</a></li><li><a href="../ochrana-proti-csrf-utokum/" class="navigation__link navigation__link--active">Ochrana proti CSRF útokům</a></li><li><a href="../integrace-webpacku/" class="navigation__link">Integrace Webpacku</a></li></ul></nav><main class="tutorial-page-layout__content"><h1 class="heading-primary u-mb-2">Ochrana proti CSRF útokům</h1><p class="article-author u-mb-4"><span class="article-author__label">Autor:</span> <a rel="author" href="https://jirkasa.github.io/" target="_blank" class="link">Jiří Satora</a></p><p class="paragraph u-mb-4">V tomto článku se dozvíte, co to jsou CSRF útoky a jak se proti nim bránit. Jedná se o věc, o které podle mě spousta začínajících programátorů webových aplikací ani neví, ale pro bezpečnost webových aplikací je ochrana proti CSRF útokům velmi důležitá.</p><h2 id="co-jsou-csrf-utoky" class="heading-secondary u-mb-2">Co jsou CSRF útoky</h2><p class="paragraph u-mb-2">Ke Cross-Site Request Forgery (CSRF) útoku dochází, když škodlivá webová stránka přiměje webový prohlížeč provést nějakou operaci na jiném webu, na kterém je uživatel, který webový prohlížeč používá, přihlášen. Webová stránka totiž má možnost posílat requesty i mimo vlastní doménu. Tímto způsobem prohlížeče fungují, není to nic neobvyklého. Příkladem mohou být odkazy, které se na webové stránce mohou nacházet a odkazovat na jakoukoliv jinou webovou stránku na internetu. Stejným způsobem to ale funguje také třeba s formuláři. Takže se může stát, že útočník na svoji webovou stránku umístí formulář směřující na jiný web, který uživatel po otevření stránky odešle. Může to být dokonce provedeno automaticky přes JavaScript.</p><p class="paragraph u-mb-4">Implementovat ochranu proti CSRF útokům je důležité, protože samozřejmě nechceme, aby si mohla jakákoliv webová stránka jen tak posílat requesty na náš web, na kterém jsou naši uživatelé přihlášení a provádět za ně různé operace. Implementace ochrany proti CSRF útokům není tak složitá, jak by se na první pohled mohlo zdát. Základní princip spočívá v použití tzv. CSRF tokenů. Jedná se o unikátní hodnotu generovanou serverem, která je přidána do každého formuláře nebo požadavku, který na serveru provádí nějakou operaci, která mění data (formuláře, které slouží jen pro nějaké vyhledávání dat, se samozřejmě zabezpečovat nemusí). Tento token je poté zkontrolován při každém požadavku na server, aby se zajistilo, že požadavek pochází od oprávněného uživatele. Až se pustíme do implementace CSRF ochrany ve vzorové aplikaci, tak pravděpodobně pochopíte jak to funguje. Více si o tvorbě CSRF ochrany můžete přečíst třeba <a href="https://github.com/OWASP/CheatSheetSeries/blob/master/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.md" target="_blank" class="link">zde</a>.</p><h2 id="ukazka-provedeni-csrf-utoku" class="heading-secondary u-mb-2">Ukázka provedení CSRF útoku</h2><p class="paragraph u-mb-4">Abychom si ukázali, jak CSRF útok může vypadat, vytvoříme si testovací aplikaci, kterou poté napadneme škodlivou webovou stránkou. Bude se jednat o aplikaci, ve které se uživatel bude moci zaregistrovat/přihlásit. Také bude mít možnost svůj účet po přihlášení zrušit. Právě to potom uděláme za uživatele, když navštíví naši škodlivou webovou stránku.</p><h3 id="vytvoreni-testovaci-aplikace" class="heading-tertiary u-mb-1">Vytvoření testovací aplikace</h3><p class="paragraph u-mb-2">Začneme tím, že si založíme nový Maven projekt, který můžeme pojmenovat třeba jako "example-app". Jako závislost si do souboru pom.xml nadefinujeme servlety.</p><div data-project="1" data-project-name="example-app" class="u-mb-2"><ul data-project-folders><li>src<ul><li>main<ul><li data-java-packages-folder>java</li><li>resources</li><li>webapp</li></ul></li><li>test<ul><li>java</li><li>resources</li></ul></li></ul></li><li>target</li></ul><pre data-code="pom.xml" data-active data-code-highlight="17-24"><code class="language-xml">&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;groupId&gt;com.example&lt;/groupId&gt;
    &lt;artifactId&gt;example-app&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;packaging&gt;war&lt;/packaging&gt;
    &lt;name&gt;example-app&lt;/name&gt;

    &lt;properties&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;
        &lt;java.version&gt;17&lt;/java.version&gt;
        &lt;maven.compiler.source&gt;${java.version}&lt;/maven.compiler.source&gt;
        &lt;maven.compiler.target&gt;${java.version}&lt;/maven.compiler.target&gt;
    &lt;/properties&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;javax.servlet&lt;/groupId&gt;
            &lt;artifactId&gt;javax.servlet-api&lt;/artifactId&gt;
            &lt;version&gt;4.0.1&lt;/version&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/project&gt;</code></pre></div><p class="paragraph u-mb-2">Teď můžeme vytvořit složku WEB-INF a v ní soubor web.xml, ve kterém si nadefinujeme a namapujeme servlety, které později vytvoříme. Obsah souboru ukazuje následující ukázka.</p><div data-project="2" data-project-extends="1" class="u-mb-2"><ul data-project-commands><li data-command-create-folder>src/main/webapp/WEB-INF</li><li data-command-open-folder-to-root>src/main/webapp/WEB-INF</li></ul><pre data-code="web.xml" data-folder="src/main/webapp/WEB-INF" data-active><code class="language-xml">&lt;web-app xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xmlns="http://java.sun.com/xml/ns/javaee"
xmlns:web="http://Java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
xsi:schemaLocation="http://java.sun.com/xml/ns/javaee
http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd" 
id="WebApp_ID" version="3.0"&gt;
    &lt;servlet&gt;
        &lt;servlet-name&gt;HomeServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;com.example.servlets.HomeServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;
    &lt;servlet&gt;
        &lt;servlet-name&gt;RegisterServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;com.example.servlets.RegisterServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;
    &lt;servlet&gt;
        &lt;servlet-name&gt;LoginServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;com.example.servlets.LoginServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;
    &lt;servlet&gt;
        &lt;servlet-name&gt;LogoutServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;com.example.servlets.LogoutServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;
    &lt;servlet&gt;
        &lt;servlet-name&gt;DeleteAccountServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;com.example.servlets.DeleteAccountServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;
    
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;HomeServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/home&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;RegisterServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/register&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;LoginServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/login&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;LogoutServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/logout&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;DeleteAccountServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/delete-account&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
&lt;/web-app&gt;</code></pre></div><p class="paragraph u-mb-2">Jak můžete v souboru web.xml vidět, naše aplikace se bude skládat z pěti servletů. Začneme se servletem pro domovskou stránku. Jeho kód a JSP stránky, které vykresluje, ukazují následující ukázky. Servlety můžete vytvářet v balíčku "com.example.servlets" a JSP soubory ve složce WEB-INF/jsp (kdyžtak si to můžete prohlédnou po otevření levého panelu u každé ukázky). Podle toho, zda je uživatel přihlášen (zda je objekt, který uživatele reprezentuje, uložen v session) se zobrazí buď uživatelská domovoská stránka, nebo veřejná domovská stránka.</p><div data-project="3" data-project-extends="2" class="u-mb-4"><pre data-code="HomeServlet.java" data-java-package="com.example.servlets" data-java-package-opened data-active><code class="language-java">package com.example.servlets;

import java.io.IOException;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import com.example.model.User;

public class HomeServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException {
        HttpSession session = req.getSession();
        User loggedUser = (User) session.getAttribute("LOGGED_USER");
        
        if (loggedUser == null) {
            // zobrazení domovské stránky pro nepřihlášeného uživatele
            RequestDispatcher dispatcher = req.getRequestDispatcher("/WEB-INF/jsp/HomePage.jsp");
            dispatcher.forward(req, res);
        } else {
            req.setAttribute("username", loggedUser.getUsername());
            // zobrazení domovské stránky pro přihlášeného uživatele
            RequestDispatcher dispatcher = req.getRequestDispatcher("/WEB-INF/jsp/UserHomePage.jsp");
            dispatcher.forward(req, res);
        }
    }
}</code></pre></div><div data-project="4" data-project-extends="3" class="u-mb-4"><ul data-project-commands><li data-command-create-folder>src/main/webapp/WEB-INF/jsp</li><li data-command-open-folder-to-root>src/main/webapp/WEB-INF/jsp</li></ul><pre data-code="HomePage.jsp" data-folder="src/main/webapp/WEB-INF/jsp" data-active><code class="language-html">&lt;%@page contentType="text/html" pageEncoding="UTF-8"%&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;Example app&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Vítejte&lt;/h1&gt;
    &lt;p&gt;Přihlašte se nebo si vytvořte účet.&lt;/p&gt;
    &lt;ul&gt;
        &lt;li&gt;&lt;a href="./login"&gt;Přihlásit se&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href="./register"&gt;Zaregistrovat se&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre></div><div data-project="5" data-project-extends="4" class="u-mb-2"><ul data-project-commands><li data-command-open-folder-to-root>src/main/webapp/WEB-INF/jsp</li></ul><pre data-code="UserHomePage.jsp" data-folder="src/main/webapp/WEB-INF/jsp" data-active><code class="language-html">&lt;%@page contentType="text/html" pageEncoding="UTF-8"%&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;Example app&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Uživatel: ${username}&lt;/h1&gt;
    &lt;ul&gt;
        &lt;li&gt;&lt;a href="./logout"&gt;Odhlásit se&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href="./delete-account"&gt;Smazat účet&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre></div><p class="paragraph u-mb-2">Uživatel bude reprezentován třídou User. Její instance budou moci být ukládány v databázi, kterou bude představovat třída UsersDatabase. Obě třídy ukazují následující ukázky. Můžete je vytvořit v balíčku "com.example.model". Nemusíte vůbec zkoumat jak třída UsersDatabase funguje. Je to jen taková testovací databáze, která ukládá data v paměti, abychom pro naše účely nemuseli používat opravdovou databázi.</p><div data-project="6" data-project-extends="5" class="u-mb-4"><pre data-code="User.java" data-java-package="com.example.model" data-java-package-opened data-active><code class="language-java">package com.example.model;

public class User {
    private int id;
    private String username;
    private String password;
    
    public int getId() {
        return id;
    }
    public void setId(int id) {
        this.id = id;
    }
    
    public String getUsername() {
        return username;
    }
    public void setUsername(String username) {
        this.username = username;
    }
    
    public String getPassword() {
        return password;
    }
    public void setPassword(String password) {
        this.password = password;
    }
}</code></pre></div><div data-project="7" data-project-extends="6" class="u-mb-2"><pre data-code="UsersDatabase.java" data-java-package="com.example.model" data-java-package-opened data-active><code class="language-java">package com.example.model;

import java.util.LinkedList;
import java.util.List;

import javax.servlet.http.HttpServletRequest;

public class UsersDatabase {
    private UsersDatabase() {}
    
    private static int counter = 0;
    
    public static void addUser(HttpServletRequest request, User user) {
        List&lt;User&gt; users = (List&lt;User&gt;) request.getServletContext().getAttribute("USERS");
        if (users == null) {
            users = new LinkedList&lt;User&gt;();
            request.getServletContext().setAttribute("USERS", users);
        }
        
        user.setId(counter);
        counter++;
        
        users.add(user);
    }
    
    public static List&lt;User&gt; getUsers(HttpServletRequest request) {
        List&lt;User&gt; users = (List&lt;User&gt;) request.getServletContext().getAttribute("USERS");
        if (users == null) users = new LinkedList&lt;User&gt;();
        return users;
    }
        
    public static User getUserById(HttpServletRequest request, int id) {
        List&lt;User&gt; users = (List&lt;User&gt;) request.getServletContext().getAttribute("USERS");
        if (users == null) users = new LinkedList&lt;User&gt;();
        
        for (User user : users) {
            if (user.getId() == id) return user;
        }
        
        return null;
    }
    
    public static User getUserByUsername(HttpServletRequest request, String username) {
        List&lt;User&gt; users = (List&lt;User&gt;) request.getServletContext().getAttribute("USERS");
        if (users == null) users = new LinkedList&lt;User&gt;();
        
        for (User user : users) {
            if (user.getUsername().equals(username)) return user;
        }
        
        return null;
    }
    
    public static void deleteUserById(HttpServletRequest request, int id) {
        List&lt;User&gt; users = (List&lt;User&gt;) request.getServletContext().getAttribute("USERS");
        if (users == null) users = new LinkedList&lt;User&gt;();
        
        for (int i = 0; i &lt; users.size(); i++) {
            User user = users.get(i);
            
            if (user.getId() == id) {
                users.remove(i);
                break;
            }
        }
    }
}</code></pre></div><p class="paragraph u-mb-2">Teď můžeme vytvořit servlet pro registraci uživatele. Jeho kód a JSP stránku, kterou vykresluje, ukazují následující ukázky. Servlet zpracovává GET i POST requesty. V metodě doGet zobrazuje stránku s formulářem a v metodě doPost tento formulář zpracovává.</p><div data-project="8" data-project-extends="7" class="u-mb-4"><pre data-code="RegisterServlet.java" data-java-package="com.example.servlets" data-java-package-opened data-active><code class="language-java">package com.example.servlets;

import java.io.IOException;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import com.example.model.User;
import com.example.model.UsersDatabase;

public class RegisterServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException {
        HttpSession session = req.getSession();
        User loggedUser = (User) session.getAttribute("LOGGED_USER");
        
        // pokud je uživatel již přihlášen, tak je přesměrován na hlavní stránku
        if (loggedUser != null) {
            res.sendRedirect("./home");
            return;
        }
        
        RequestDispatcher dispatcher = req.getRequestDispatcher("/WEB-INF/jsp/RegisterPage.jsp");
        dispatcher.forward(req, res);
    }

    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException {
        String username = req.getParameter("username");
        String password = req.getParameter("password");
        
        // pro jednoduchost se nezabýváme žádnou velkou validací, pouze zkontrolujeme
        // zda se uživatel s tímto uživatelským jménem nenachází v databázi
        User existingUser = UsersDatabase.getUserByUsername(req, username);
        
        // pokud uživatel již existuje, tak mu znovu zobrazíme stránku pro registraci
        // (pro jednoduchost nezobrazujeme žádnou validační zprávu)
        if (existingUser != null) {
            res.sendRedirect("./register");
            return;
        }
        
        // vytvoření uživatele
        User user = new User();
        user.setUsername(username);
        user.setPassword(password);
        
        // uložení uživatele do databáze
        UsersDatabase.addUser(req, user);
        
        // uložení uživatele do session
        HttpSession session = req.getSession();
        session.setAttribute("LOGGED_USER", user);
        
        // přesměrování na hlavní stránku
        res.sendRedirect("./home");
    }
}</code></pre></div><div data-project="9" data-project-extends="8" class="u-mb-2"><ul data-project-commands><li data-command-open-folder-to-root>src/main/webapp/WEB-INF/jsp</li></ul><pre data-code="RegisterPage.jsp" data-folder="src/main/webapp/WEB-INF/jsp" data-active><code class="language-html">&lt;%@page contentType="text/html" pageEncoding="UTF-8"%&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;Example app&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Registrace&lt;/h1&gt;
    &lt;form action="./register" method="POST"&gt;
        &lt;label&gt;Uživatelské jméno:&lt;/label&gt; &lt;input type="text" name="username"/&gt;&lt;br&gt;
        &lt;label&gt;Heslo:&lt;/label&gt; &lt;input type="password" name="password"/&gt;&lt;br&gt;
        &lt;button type="submit"&gt;Zaregistrovat se&lt;/button&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre></div><p class="paragraph u-mb-2">Dále vytvoříme servlet pro přihlášení. Jeho kód a JSP stránku, kterou vykresluje, si opět můžete prohlédnout v následujích ukázkách.</p><div data-project="10" data-project-extends="9" class="u-mb-4"><pre data-code="LoginServlet.java" data-java-package="com.example.servlets" data-java-package-opened data-active><code class="language-java">package com.example.servlets;

import java.io.IOException;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import com.example.model.User;
import com.example.model.UsersDatabase;

public class LoginServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException {
        HttpSession session = req.getSession();
        User loggedUser = (User) session.getAttribute("LOGGED_USER");
        
        // pokud je uživatel již přihlášen, tak je přesměrován na hlavní stránku
        if (loggedUser != null) {
            res.sendRedirect("./home");
            return;
        }
        
        RequestDispatcher dispatcher = req.getRequestDispatcher("/WEB-INF/jsp/LoginPage.jsp");
        dispatcher.forward(req, res);
    }
    
    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException {
        String username = req.getParameter("username");
        String password = req.getParameter("password");
        
        // nalezení uživatele v databázi podle uživatelského jména
        User user = UsersDatabase.getUserByUsername(req, username);
        
        // pokud se uživatel nenašel nebo je špatné heslo,
        // tak se stránka pro přihlášení zobrazí znovu
        if (user == null || !user.getPassword().equals(password)) {
            res.sendRedirect("./login");
            return;
        }
        
        // uložení uživatele do session
        HttpSession session = req.getSession();
        session.setAttribute("LOGGED_USER", user);
        
        // přesměrování na hlavní stránku
        res.sendRedirect("./home");
    }
}</code></pre></div><div data-project="11" data-project-extends="10" class="u-mb-2"><ul data-project-commands><li data-command-open-folder-to-root>src/main/webapp/WEB-INF/jsp</li></ul><pre data-code="LoginPage.jsp" data-folder="src/main/webapp/WEB-INF/jsp" data-active><code class="language-html">&lt;%@page contentType="text/html" pageEncoding="UTF-8"%&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;Example app&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Přihlášení&lt;/h1&gt;
    &lt;form action="./login" method="POST"&gt;
        &lt;label&gt;Uživatelské jméno:&lt;/label&gt; &lt;input type="text" name="username"/&gt;&lt;br&gt;
        &lt;label&gt;Heslo:&lt;/label&gt; &lt;input type="password" name="password"/&gt;&lt;br&gt;
        &lt;button type="submit"&gt;Přihlásit se&lt;/button&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre></div><p class="paragraph u-mb-2">Teď vytvoříme servlet pro smazání účtu. Pokud si bude chtít uživatel smazat účet, tak se mu nejprve zobrazí stránka, kde na to bude mít tlačítko, a když na toto tlačítko klikne, tak se jeho účet smaže. Následující ukázky ukazují kód servletu a JSP stránky.</p><div data-project="12" data-project-extends="11" class="u-mb-4"><pre data-code="DeleteAccountServlet.java" data-java-package="com.example.servlets" data-java-package-opened data-active><code class="language-java">package com.example.servlets;

import java.io.IOException;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import com.example.model.User;
import com.example.model.UsersDatabase;

public class DeleteAccountServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException {
        HttpSession session = req.getSession();
        User loggedUser = (User) session.getAttribute("LOGGED_USER");
        
        if (loggedUser == null) {
            res.sendRedirect("./home");
            return;
        }
        
        RequestDispatcher dispatcher = req.getRequestDispatcher("/WEB-INF/jsp/DeleteAccountPage.jsp");
        dispatcher.forward(req, res);
    }
    
    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException {
        HttpSession session = req.getSession();
        User loggedUser = (User) session.getAttribute("LOGGED_USER");
        
        // pokud uživatel není přihlášen, tak je jen přesměrován na hlavní stránku
        if (loggedUser == null) {
            res.sendRedirect("./home");
            return;
        }
        
        // odstranění uživatele z databáze
        UsersDatabase.deleteUserById(req, loggedUser.getId());
        // odstranění uživatele ze session
        session.removeAttribute("LOGGED_USER");
        // přesměrování na hlavní stránku
        res.sendRedirect("./home");
    }
}</code></pre></div><div data-project="13" data-project-extends="12" class="u-mb-2"><ul data-project-commands><li data-command-open-folder-to-root>src/main/webapp/WEB-INF/jsp</li></ul><pre data-code="DeleteAccountPage.jsp" data-folder="src/main/webapp/WEB-INF/jsp" data-active><code class="language-html">&lt;%@page contentType="text/html" pageEncoding="UTF-8"%&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;Example app&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Smazat účet&lt;/h1&gt;
    &lt;p&gt;Opravdu si přejete smazat svůj účet?&lt;/p&gt;
    &lt;form action="./delete-account" method="POST"&gt;
        &lt;button type="submit"&gt;Smazat účet&lt;/button&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre></div><p class="paragraph u-mb-2">Teď již zbývá jen servlet pro odhlášení. Ukazuje jej následující ukázka.</p><div data-project="14" data-project-extends="13" class="u-mb-2"><pre data-code="LogoutServlet.java" data-java-package="com.example.servlets" data-java-package-opened data-active><code class="language-java">package com.example.servlets;

import java.io.IOException;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

public class LogoutServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException {
        // odstranění uživatele ze session
        HttpSession session = req.getSession();
        session.removeAttribute("LOGGED_USER");
        
        // přesměrování na hlavní stránku
        res.sendRedirect("./home");
    }
}</code></pre></div><p class="paragraph u-mb-2">Naše aplikace je hotová. Pokud jste si ji sami neprogramovali podle tohoto článku, tak si alespoň v následujícím slideru můžete prohlédnout jak vypadá, a jak ji uživatel může používat.</p><div data-slider class="splide u-mb-4" role="group" aria-label="Ukázka testovací aplikace pro CSRF útok"><div class="splide__track"><ul class="splide__list"><li class="splide__slide"><div class="slider-page"><img src="../../static/img/sliders/csrf-token-example-app/csrf-token-example-app-part1.png" alt="Ukázka testovací aplikace pro CSRF útok - část 1" class="slider-page__image"><div class="slider-page__description"><p class="paragraph">Na hlavní stránce (<a href="http://localhost:8080/example-app/home" target="_blank" class="link">http://localhost:8080/example-app/home</a>) má uživatel možnost se zaregistrovat.</p></div></div></li><li class="splide__slide"><div class="slider-page"><img src="../../static/img/sliders/csrf-token-example-app/csrf-token-example-app-part2.png" alt="Ukázka testovací aplikace pro CSRF útok - část 2" class="slider-page__image"><div class="slider-page__description"><p class="paragraph">Po kliknutí na "Zaregistrovat se" se uživateli zobrazí formulář pro registraci.</p></div></div></li><li class="splide__slide"><div class="slider-page"><img data-splide-lazy="../../static/img/sliders/csrf-token-example-app/csrf-token-example-app-part3.png" alt="Ukázka testovací aplikace pro CSRF útok - část 3" class="slider-page__image"><div class="slider-page__description"><p class="paragraph">Uživatel formulář vyplní a odešle jej kliknutím na tlačítko "Zaregistrovat se".</p></div></div></li><li class="splide__slide"><div class="slider-page"><img data-splide-lazy="../../static/img/sliders/csrf-token-example-app/csrf-token-example-app-part4.png" alt="Ukázka testovací aplikace pro CSRF útok - část 4" class="slider-page__image"><div class="slider-page__description"><p class="paragraph">Po registraci je uživatel automaticky přihlášen a zobrazí se mu jeho hlavní stránka.</p></div></div></li><li class="splide__slide"><div class="slider-page"><img data-splide-lazy="../../static/img/sliders/csrf-token-example-app/csrf-token-example-app-part5.png" alt="Ukázka testovací aplikace pro CSRF útok - část 5" class="slider-page__image"><div class="slider-page__description"><p class="paragraph">Kliknutím na "Odhlásit se" se uživatel může odhlásit.</p></div></div></li><li class="splide__slide"><div class="slider-page"><img data-splide-lazy="../../static/img/sliders/csrf-token-example-app/csrf-token-example-app-part6.png" alt="Ukázka testovací aplikace pro CSRF útok - část 6" class="slider-page__image"><div class="slider-page__description"><p class="paragraph">Po odhlášení se uživatel může přihlásit kliknutím na "Přihlásit se".</p></div></div></li><li class="splide__slide"><div class="slider-page"><img data-splide-lazy="../../static/img/sliders/csrf-token-example-app/csrf-token-example-app-part7.png" alt="Ukázka testovací aplikace pro CSRF útok - část 7" class="slider-page__image"><div class="slider-page__description"><p class="paragraph">Uživateli se zobrazí formulář pro přihlášení.</p></div></div></li><li class="splide__slide"><div class="slider-page"><img data-splide-lazy="../../static/img/sliders/csrf-token-example-app/csrf-token-example-app-part8.png" alt="Ukázka testovací aplikace pro CSRF útok - část 8" class="slider-page__image"><div class="slider-page__description"><p class="paragraph">Uživatel zadá správné přihlašovací údaje a kliknutím na "Přihlásit se" se přihlásí.</p></div></div></li><li class="splide__slide"><div class="slider-page"><img data-splide-lazy="../../static/img/sliders/csrf-token-example-app/csrf-token-example-app-part9.png" alt="Ukázka testovací aplikace pro CSRF útok - část 9" class="slider-page__image"><div class="slider-page__description"><p class="paragraph">Na hlavní stránce uživatele se nachází možnost smazat účet.</p></div></div></li><li class="splide__slide"><div class="slider-page"><img data-splide-lazy="../../static/img/sliders/csrf-token-example-app/csrf-token-example-app-part10.png" alt="Ukázka testovací aplikace pro CSRF útok - část 10" class="slider-page__image"><div class="slider-page__description"><p class="paragraph">Po kliknutí na možnost "Smazat účet" se uživateli zobrazí stránka, na které může potvrdit, že svůj účet chce opravdu smazat.</p></div></div></li><li class="splide__slide"><div class="slider-page"><img data-splide-lazy="../../static/img/sliders/csrf-token-example-app/csrf-token-example-app-part11.png" alt="Ukázka testovací aplikace pro CSRF útok - část 11" class="slider-page__image"><div class="slider-page__description"><p class="paragraph">Po smazání účtu se uživateli zobrazí veřejná domovská stránka.</p></div></div></li></ul></div></div><h3 id="vytvoreni-skodlive-webove-stranky" class="heading-tertiary u-mb-1">Vytvoření škodlivé webové stránky</h3><p class="paragraph u-mb-2">Teď když máme připravenou testovací aplikaci, tak si vytvoříme webovou stránku, pomocí které tuto aplikaci napadneme. Pokud si ji přihlášený uživatel otevře, smaže se mu účet.</p><p class="paragraph u-mb-2">Založíme si nový Maven projekt (můžete jej pojmenovat třeba jako "bad-app") a jedinou věc kterou uděláme, je vytvoření JSP stránky s názvem "Home.jsp" přímo ve složce webapp, abychom nemuseli nic mapovat v souboru web.xml. Kód stránky ukazuje následující ukázka. Nachází se na ní formulář, který se posílá na servlet pro smazání účtu metodou POST. Tento formulář se navíc automaticky odesílá při načtení stránky přes JavaScript, takže opravdu stačí jen to, že uživatel webovou stránku navštíví.</p><div data-project="15" data-project-name="bad-app" class="u-mb-4"><ul data-project-folders><li data-opened>src<ul><li data-opened>main<ul><li data-java-packages-folder>java</li><li>resources</li><li data-opened>webapp</li></ul></li><li>test<ul><li>java</li><li>resources</li></ul></li></ul></li><li>target</li></ul><pre data-code="pom.xml"><code class="language-xml">&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;groupId&gt;com.example&lt;/groupId&gt;
    &lt;artifactId&gt;bad-app&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;packaging&gt;war&lt;/packaging&gt;
    &lt;name&gt;bad-app&lt;/name&gt;
&lt;/project&gt;</code></pre><pre data-code="Home.jsp" data-folder="src/main/webapp" data-active><code class="language-html">&lt;%@page contentType="text/html" pageEncoding="UTF-8"%&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;Bad app&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;form id="form" method="POST" action="http://localhost:8080/example-app/delete-account"&gt;&lt;/form&gt;
    &lt;script&gt;
        document.getElementById("form").submit();
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre></div><h3 id="smazani-uctu-prihlaseneho-uzivatele" class="heading-tertiary u-mb-1">Smazání účtu přihlášeného uživatele</h3><p class="paragraph u-mb-2">Aplikaci pro naši škodlivou stránku si nasadíme na jiný server, který spustíme na jiném portu (například na 9090). Pokud používáte Eclipse IDE, tak si v následujícím slideru můžete prohlédnout, jak to udělat.</p><div data-slider class="splide u-mb-4" role="group" aria-label="Přidání druhého serveru do Eclipse IDE"><div class="splide__track"><ul class="splide__list"><li class="splide__slide"><div class="slider-page"><img src="../../static/img/sliders/add-second-server-to-eclipse/add-second-server-to-eclipse-part1.png" alt="Přidání druhého serveru do Eclipse IDE - část 1" class="slider-page__image"><div class="slider-page__description"><p class="paragraph">V záložce "Servers" klikneme pravým tlačítkem a vybereme že chceme vytvořit nový server.</p></div></div></li><li class="splide__slide"><div class="slider-page"><img src="../../static/img/sliders/add-second-server-to-eclipse/add-second-server-to-eclipse-part2.png" alt="Přidání druhého serveru do Eclipse IDE - část 2" class="slider-page__image"><div class="slider-page__description"><p class="paragraph">Vybereme co za server chceme vytvořit, nějak jej pojmenujeme a klikneme na "Finish".</p></div></div></li><li class="splide__slide"><div class="slider-page"><img data-splide-lazy="../../static/img/sliders/add-second-server-to-eclipse/add-second-server-to-eclipse-part3.png" alt="Přidání druhého serveru do Eclipse IDE - část 3" class="slider-page__image"><div class="slider-page__description"><p class="paragraph">Na vytvořený server klikneme pravým tlačítkem a vybereme "Add and Remove...".</p></div></div></li><li class="splide__slide"><div class="slider-page"><img data-splide-lazy="../../static/img/sliders/add-second-server-to-eclipse/add-second-server-to-eclipse-part4.png" alt="Přidání druhého serveru do Eclipse IDE - část 4" class="slider-page__image"><div class="slider-page__description"><p class="paragraph">Na server si přidáme aplikaci s naší škodlivou stránkou.</p></div></div></li><li class="splide__slide"><div class="slider-page"><img data-splide-lazy="../../static/img/sliders/add-second-server-to-eclipse/add-second-server-to-eclipse-part5.png" alt="Přidání druhého serveru do Eclipse IDE - část 5" class="slider-page__image"><div class="slider-page__description"><p class="paragraph">Po přidání aplikace klikneme na "Finish".</p></div></div></li><li class="splide__slide"><div class="slider-page"><img data-splide-lazy="../../static/img/sliders/add-second-server-to-eclipse/add-second-server-to-eclipse-part6.png" alt="Přidání druhého serveru do Eclipse IDE - část 6" class="slider-page__image"><div class="slider-page__description"><p class="paragraph">Na závěr si otevřeme nastavení serveru dvojtým klikem myši na serveru a přenastavíme port na kterém bude server běžet a také nastavíme admin port. Poté stiskneme ctrl + s pro uložení.</p></div></div></li></ul></div></div><p class="paragraph u-mb-4">Server s testovací aplikací i server se škodlivou webovou stránkou si můžete spustit. V testovací aplikaci si můžete zkusit zaregistrovat uživatele a nechat jej přihlášeného. Poté můžete navštívit škodlivou webovou stránku a tomuto přihlášenému uživateli by se měl smazat účet. Pokud jste nastavili port serveru na 9090, tak bude škodlivá webová stránka k dispozici zde: <a href="http://localhost:9090/bad-app/Home.jsp" target="_blank" class="link">http://localhost:9090/bad-app/Home.jsp</a>.</p><h2 id="implementace-ochrany-proti-csrf-utokum" class="heading-secondary u-mb-2">Implementace ochrany proti CSRF útokům</h2><p class="paragraph u-mb-2">Když jsme si teď ukázali, jak CSRF útok může vypadat, tak si také ukážeme, jak se proti němu bránit. Jak jsem již psal, používají se k tomu tzv. CSRF tokeny. Jedná se o unikátní hodnotu, která je pro každého uživatele vygenerována na serveru, a přidává se do každého formuláře, který na serveru provádí nějakou operaci (většinou jako skrytý input typu hidden). Když se formulář s CSRF tokenem odešle, tak se zjistí, zda je CSRF token validní a pokud ne, server požadovanou operaci neprovede. Škodlivá stránka se samozřejmě posílá ze serveru útočníka, který k CSRF tokenu uloženém v naší aplikaci nemá přístup, a nemůže jej tedy jen tak umístit do svého formuláře, směřující na náš server.</p><p class="paragraph u-mb-2">V naší aplikaci nám tedy stačí pro uživatele vygenerovat nějakou náhodnou hodnotu, uložit ji do session a při každém requestu o smazání účtu kontrolovat, zda se tato hodnota posílá a zda je správná. Následující ukázka ukazuje upravený kód servletu pro smazání účtu. Při načítání stránky (pro GET request) generujeme pro uživatele CSRF token (pokud jej ještě nemá vygenerovaný) a nastavujeme jej jako atribut do requestu, aby jej mohla JSP stránka přidat do formuláře. Při zpracovávání formuláře poté zjišťujeme, zda je CSRF token správný a můžeme uživateli účet smazat. Pokud správný není, tak posíláme chybovou stránku.</p><div data-project="16" data-project-extends="14" class="u-mb-2"><pre data-code="DeleteAccountServlet.java" data-java-package="com.example.servlets" data-java-package-opened data-active data-code-highlight="29-43,60-76,87-94"><code class="language-java">package com.example.servlets;

import java.io.IOException;
import java.security.NoSuchAlgorithmException;
import java.security.SecureRandom;
import java.util.Base64;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import com.example.model.User;
import com.example.model.UsersDatabase;

public class DeleteAccountServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException {
        HttpSession session = req.getSession();
        User loggedUser = (User) session.getAttribute("LOGGED_USER");
        
        if (loggedUser == null) {
            res.sendRedirect("./home");
            return;
        }
        
        String csrfToken = (String) session.getAttribute("CSRF_TOKEN");
        
        // pokud CSRF token ještě pro uživatele není vygenerovaný,
        // tak se vygeneruje a uloží do session
        if (csrfToken == null) {
            try {
                csrfToken = generateToken();
                session.setAttribute("CSRF_TOKEN", csrfToken);
            } catch (NoSuchAlgorithmException e) {
                System.out.println(e);
            }
        }
        
        // nastavení CSRF tokenu do requestu, aby jej JSP stránka mohla přidat do formuláře
        req.setAttribute("CSRF_TOKEN", csrfToken);
        
        RequestDispatcher dispatcher = req.getRequestDispatcher("/WEB-INF/jsp/DeleteAccountPage.jsp");
        dispatcher.forward(req, res);
    }
    
    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException {
        HttpSession session = req.getSession();
        User loggedUser = (User) session.getAttribute("LOGGED_USER");
        
        // pokud uživatel není přihlášen, tak je jen přesměrován na hlavní stránku
        if (loggedUser == null) {
            res.sendRedirect("./home");
            return;
        }
        
        // získání CSRF tokenu ze session
        String csrfToken = (String) session.getAttribute("CSRF_TOKEN");
        // získání CSRF tokenu z poslaného formuláře
        String passedCsrfToken = (String) req.getParameter("CSRF_TOKEN");
        
        // pokud CSRF token nebyl poslán, neshoduje se s CSRF tokenem uloženým v session nebo ještě
        // pro uživatele nebyl vygenerován, tak se namísto smazání účtu zobrazí chybová stránka
        if (
            csrfToken == null
            || passedCsrfToken == null
            || !csrfToken.equals(passedCsrfToken)
        ) {
            res.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
            RequestDispatcher dispatcher = req.getRequestDispatcher("/WEB-INF/jsp/BadCSRFTokenPage.jsp");
            dispatcher.forward(req, res);
            return;
        }
            
        
        // odstranění uživatele z databáze
        UsersDatabase.deleteUserById(req, loggedUser.getId());
        // odstranění uživatele ze session
        session.removeAttribute("LOGGED_USER");
        // přesměrování na hlavní stránku
        res.sendRedirect("./home");
    }
    
    // metoda pro vygenerování CSRF tokenu
    public static String generateToken() throws NoSuchAlgorithmException {
        SecureRandom secureRandom = SecureRandom.getInstance("SHA1PRNG");
        byte[] data = new byte[16];
        secureRandom.nextBytes(data);

        return Base64.getEncoder().encodeToString(data);
    }
}</code></pre></div><p class="paragraph u-mb-2">Upravenou JSP stránku "DeleteAccountPage.jsp", která teď do formuláře navíc přidává skrytý input s hodnotou CSRF tokenu ukazuje následující ukázka.</p><div data-project="17" data-project-extends="16" class="u-mb-2"><ul data-project-commands><li data-command-open-folder-to-root>src/main/webapp/WEB-INF/jsp</li></ul><pre data-code="DeleteAccountPage.jsp" data-folder="src/main/webapp/WEB-INF/jsp" data-active data-code-highlight="12"><code class="language-html">&lt;%@page contentType="text/html" pageEncoding="UTF-8"%&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;Example app&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Smazat účet&lt;/h1&gt;
    &lt;p&gt;Opravdu si přejete smazat svůj účet?&lt;/p&gt;
    &lt;form action="./delete-account" method="POST"&gt;
        &lt;input type="hidden" name="CSRF_TOKEN" value="${CSRF_TOKEN}"/&gt;
        &lt;button type="submit"&gt;Smazat účet&lt;/button&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre></div><p class="paragraph u-mb-2">Novou JSP stránku, která se zobrazuje když se pošle špatný CSRF token, ukazuje následující ukázka. Obsahuje pouze zprávu o tom, že se poslal špatný token.</p><div data-project="18" data-project-extends="17" class="u-mb-2"><ul data-project-commands><li data-command-open-folder-to-root>src/main/webapp/WEB-INF/jsp</li></ul><pre data-code="BadCSRFTokenPage.jsp" data-folder="src/main/webapp/WEB-INF/jsp" data-active><code class="language-html">&lt;%@page contentType="text/html" pageEncoding="UTF-8"%&gt;
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;Example app&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Došlo k chybě&lt;/h1&gt;
    &lt;p&gt;Byl poslán špatný CSRF token.&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre></div><p class="paragraph u-mb-2">Pokud si nyní v naší testovací aplikaci necháte přihlášeného uživatele a zkusíte navštívit škodlivou webovou stránku, tak se vám zobrazí stránka se zprávou, že byl poslán špatný CSRF token, ale účet se nesmaže. Úspěšně jsme tedy implementovali ochranu proti CSRF útokům.</p><img src="../../static/img/screenshots/CSRFTokenUkazkovaAplikaceSpatnyCSRFToken.png" alt="Chybová stránka - špatný CSRF token" class="image image--full-width image--with-border u-mb-2"><p class="paragraph u-mb-4">Možná vás napadlo to, že by si útočník mohl stránku pro smazání účtu uživatele stáhnout pomocí JavaScriptu a přečíst si z ní CSRF token, který by vložil do svého formuláře, než by jej odeslal. To ale defaultně udělat nemůže. Webové prohlížeče totiž implementují mechanismus, kterému se říká Cross-Origin Resource Sharing (CORS). Více si o tom můžete přečíst třeba na <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" target="_blank" class="link">MDN</a>. JavaScript jednoduše nemá přístup k odpovědím z requestů, které posílá na servery v jiné doméně. Museli by mu to dovolit pomocí HTTP headeru Access-Control-Allow-Origin. Buďte tedy při nastavování tohoto headeru opatrní a nenastavujte jej jen tak pro každého.</p><h2 id="csrf-ochrana-pro-knihovnu-servlet-router" class="heading-secondary u-mb-2">CSRF ochrana pro knihovnu Servlet Router</h2><p class="paragraph u-mb-2">Pokud pro tvorbu webových aplikací používáte knihovnu Servlet Router, o které jsem psal v <a href="../servlet-router/" class="link">tomto článku</a>, tak můžete pro implementaci ochrany proti CSRF útokům použít middleware, který jsem pro ni vytvořil.</p><div class="buttons-banner u-mb-2"><a href="https://mvnrepository.com/artifact/io.github.jirkasa/servlet-router-csrf-protection" target="_blank" class="buttons-banner__button buttons-banner__button--mvn-repository"><svg><use xlink:href="../../static/icon-sprite.svg#mvn-repository"></use></svg> <span>MVN Repository</span> </a><a href="https://jirkasa.github.io/servlet-router-csrf-protection/io/github/jirkasa/csrfprotection/package-summary.html" target="_blank" class="buttons-banner__button buttons-banner__button--javadoc"><svg><use xlink:href="../../static/icon-sprite.svg#java"></use></svg> <span>JavaDoc</span> </a><a href="https://github.com/Jirkasa/servlet-router-csrf-protection" target="_blank" class="buttons-banner__button buttons-banner__button--github"><svg><use xlink:href="../../static/icon-sprite.svg#github"></use></svg> <span>GitHub</span></a></div><p class="paragraph u-mb-2">Implementace CSRF ochrany pomocí tohoto middlewaru je velmi jednoduchá. Stačí si vytvořit podtřídu třídy <a href="https://jirkasa.github.io/servlet-router-csrf-protection/io/github/jirkasa/csrfprotection/CSRFProtection.html" target="_blank" class="link">CSRFProtection</a> a implementovat metodu handleError. Tato metoda se volá, když se nepředá žádný nebo špatný CSRF token a můžete v ní tedy třeba poslat nějakou stránku s chybovou zprávou. Poté stačí middleware zaregistrovat někde na začátku vašeho hlavního routeru. Bude se starat o generování CSRF tokenu pro každou session, jeho nastavování jako atributu do requestu a dále také samozřejmě bude pro každý request poslaný HTTP metodou, která mění data, ověřovat, zda se CSRF token předává a zda je správný. Příklad vytvoření middlewaru a jeho zaregistrování ukazuje následující ukázka.</p><div data-code-box class="u-mb-2"><pre data-code="MyCSRFProtection.java" data-active><code class="language-java">public class MyCSRFProtection extends CSRFProtection {
    @Override
    public void handleError(HttpServletRequest request, HttpServletResponse response) throws Exception {
        response.sendError(HttpServletResponse.SC_UNAUTHORIZED);
    }
}</code></pre><pre data-code="AppRouter.java" data-code-highlight="4"><code class="language-java">public class AppRouter extends HttpRouter {
    public AppRouter() {
        register(new BaseURLAttributeSetter());
        register(new MyCSRFProtection());
        register("/", HomeController.class);
        register("/games", new GamesRouter());
        registerErrorController(MyErrorController.class);
    }
}</code></pre></div><p class="paragraph u-mb-2">CSRFProtection middleware nastavuje CSRF token jako atribut requestu, takže jej potom můžete v JSP stránkách přidávat do formulářů jako skrytý input, nebo nastavovat jako globální proměnnou pro JavaScript. Příklad ukazuje následující ukázka.</p><div data-code-box class="u-mb-2"><pre data-code="HTML formulář" data-active data-code-highlight="2"><code class="language-html">&lt;form action="${BASE_URL}/login" method="POST"&gt;
    &lt;input name="CSRF_TOKEN" value="${CSRF_TOKEN}" type="hidden"&gt;
    &lt;input name="username" type="text" required&gt;
    &lt;input name="password" type="password" required&gt;
    &lt;button type="submit"&gt;Přihlásit se&lt;/button&gt;
&lt;/form&gt;</code></pre><pre data-code="JavaScript" data-code-highlight="4"><code class="language-html">&lt;script&gt;
    // nastavení globální proměnné, kterou může použít
    // JavaScript kód, když se přes něj bude posílat request
    const CSRF_TOKEN = ${CSRF_TOKEN};
&lt;/script&gt;</code></pre></div><p class="paragraph u-mb-2">Defaultně jsou proti CSRF útokům chráněny pouze metody POST, PUT, PATCH a DELETE. U metod GET, HEAD, TRACE a OPTIONS se totiž předpokládá, že je nebudete používat pro žádné měnění dat na serveru. Formuláře posílané metodou GET by měli sloužit jen pro získání nějakých dat, takže nejsou z hlediska CSRF útoků nebezpečné. Pokud byste to ale chtěli změnit, tak si můžete sami nadefinovat, které HTTP metody mají být zabezpečené (nedoporučuji to).</p><div data-code-box data-no-buttons class="u-mb-2"><pre data-code data-code-highlight="3-4"><code class="language-java">public class MyCSRFProtection extends CSRFProtection {
    public MyCSRFProtection() {
        // pouze metody POST a PUT budou chráněné proti CSRF útokům
        super(new String[]{"POST", "PUT"});
    }
    
    @Override
    public void handleError(HttpServletRequest request, HttpServletResponse response) throws Exception {
        response.sendError(HttpServletResponse.SC_UNAUTHORIZED);
    }
}</code></pre></div><p class="paragraph u-mb-2">Pokud by vám nevyhovoval název atributu "CSRF_TOKEN", tak jej lze také změnit, jak ukazuje následující ukázka.</p><div data-code-box class="u-mb-2"><pre data-code="MyCSRFProtection.java" data-active data-code-highlight="3"><code class="language-java">public class MyCSRFProtection extends CSRFProtection {
    public MyCSRFProtection() {
        super("MY_CSRF_TOKEN");
    }
    
    @Override
    public void handleError(HttpServletRequest request, HttpServletResponse response) throws Exception {
        response.sendError(HttpServletResponse.SC_UNAUTHORIZED);
    }
}</code></pre><pre data-code="HTML formulář" data-code-highlight="2"><code class="language-html">&lt;form action="${BASE_URL}/login" method="POST"&gt;
    &lt;input name="MY_CSRF_TOKEN" value="${MY_CSRF_TOKEN}" type="hidden"&gt;
    &lt;input name="username" type="text" required&gt;
    &lt;input name="password" type="password" required&gt;
    &lt;button type="submit"&gt;Přihlásit se&lt;/button&gt;
&lt;/form&gt;</code></pre></div><p class="paragraph u-mb-2">Pokud byste chtěli změnit název atributu i chráněné metody zároveň, tak můžete do konstruktoru předat dva parametry, jak ukazuje následující ukázka.</p><div data-code-box data-no-buttons><pre data-code data-code-highlight="3"><code class="language-java">public class MyCSRFProtection extends CSRFProtection {
    public MyCSRFProtection() {
        super("MY_CSRF_TOKEN", new String[]{"POST", "PUT"});
    }
    
    @Override
    public void handleError(HttpServletRequest request, HttpServletResponse response) throws Exception {
        response.sendError(HttpServletResponse.SC_UNAUTHORIZED);
    }
}</code></pre></div></main></div></div><footer class="footer"><div class="footer__content"><p class="footer__text">Tento web vytvořil <a href="https://jirkasa.github.io/" target="_blank" class="footer__link">Jiří Satora</a></p></div></footer></body></html>